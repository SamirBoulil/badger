{% extends 'GateBundle::base.html.twig' %}

{% block body %}
    <div class="ui main container ir-badge-proposals">
        <div class="ui segment">
            <div>
                <a class="ui right floated button" href="{{ url('badge_proposal_new') }}"><i class="ui plus icon"></i> Propose a badge</a>
                <h2 class="ui header main-title">Badge Proposals</h2>
            </div>
            <div class="badge-proposals">
                {% set badgeProposals = badgeVoteSummary.getBadgeProposals %}
                {% if badgeProposals is not empty %}
                    {% for badgeProposal in badgeProposals %}
                        <div
                            class="ui grid {% if true == badgeVoteSummary.hasUpvoted(badgeProposal) %} voteup{% endif %} {% if true == badgeVoteSummary.hasDownvoted(badgeProposal) %} votedown{% endif %}"
                            style="clear:both"
                            data-badge-proposal-id="{{ badgeProposal.id }}"
                            data-count-up-votes="{{ badgeVoteSummary.countUpvotes(badgeProposal) }}"
                            data-count-down-votes="{{ badgeVoteSummary.countDownvotes(badgeProposal) }}"
                        >
                            <div class="ten wide column">
                                <h3>{{ badgeProposal.title }}</h3>
                                <div class="description">{{ badgeProposal.description }}</div>
                            </div>
                            <div class="three wide column leaderboard-username">
                                <div class="ui mini circular image">
                                    <img src="{{ badgeProposal.user.profilePicture }}">
                                </div>
                                <a style="font-weight: normal;" href="{{ url('userprofile', {'username': badgeProposal.user.username}) }}" class="header">{{ badgeProposal.user.username }}</a>
                                <span style="font-size: 20px; font-weight: bold;" class="ui right floated"></span>
                            </div>
                            <div class="one wide column vote downvote">
                                <a href="#" class="downvote-button">
                                    <i class="fa fa-thumbs-o-down"></i>
                                </a>
                                <div class="votes-count"></div>
                            </div>
                            <div class="one wide column score"></div>
                            <div class="one wide column vote upvote">
                                <a href="#" class="upvote-button">
                                    <i class="fa fa-thumbs-o-up"></i>
                                </a>
                                <div class="votes-count"></div>
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                {% else %}
                    There is no badge proposal for now!
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        function updateVotes($proposal) {
            $proposal.find('.upvote .votes-count').html($proposal.data('count-up-votes'));
            $proposal.find('.downvote .votes-count').html($proposal.data('count-down-votes'));
            count = $proposal.data('count-up-votes') - $proposal.data('count-down-votes');
            if (count > 0) {
                $proposal.find('.score').removeClass('negative').addClass('positive').html('+' + count);
            } else if (count < 0) {
                $proposal.find('.score').removeClass('positive').addClass('negative').html(count);
            } else {
                $proposal.find('.score').removeClass('positive').removeClass('negative').html(0);
            }

        }

        $(document).ready(function() {
            $('.upvote-button').click(function () {
                var $proposal = $(this).closest('.grid');
                $.post(
                        '{{ url('badge_proposal_toggle_upvote') }}',
                        { badgeProposalId: $proposal.data('badge-proposal-id') },
                        function() {
                            if ($proposal.hasClass('voteup')) {
                                $proposal
                                    .removeClass('voteup')
                                    .data('count-up-votes', $proposal.data('count-up-votes') - 1);
                            } else if ($proposal.hasClass('votedown')) {
                                $proposal
                                    .removeClass('votedown')
                                    .addClass('voteup')
                                    .data('count-up-votes', $proposal.data('count-up-votes') + 1)
                                    .data('count-down-votes', $proposal.data('count-down-votes') - 1);
                            } else {
                                $proposal
                                    .addClass('voteup')
                                    .data('count-up-votes', $proposal.data('count-up-votes') + 1);
                            }
                            updateVotes($proposal);
                        }
                );
                return false;
            });
            $('.downvote-button').click(function () {
                var $proposal = $(this).closest('.grid');
                $.post(
                        '{{ url('badge_proposal_toggle_downvote') }}',
                        { badgeProposalId: $proposal.data('badge-proposal-id') },
                        function() {
                            if ($proposal.hasClass('votedown')) {
                                $proposal
                                        .removeClass('votedown')
                                        .data('count-down-votes', $proposal.data('count-down-votes') - 1);
                            } else if ($proposal.hasClass('voteup')) {
                                $proposal
                                        .removeClass('voteup')
                                        .addClass('votedown')
                                        .data('count-down-votes', $proposal.data('count-down-votes') + 1)
                                        .data('count-up-votes', $proposal.data('count-up-votes') - 1);
                            } else {
                                $proposal
                                        .addClass('votedown')
                                        .data('count-down-votes', $proposal.data('count-down-votes') + 1);
                            }
                            updateVotes($proposal);
                        }
                );
                return false;
            });

            $('.badge-proposals .grid').each(function() {
                updateVotes($(this));
            });
        });
    </script>
{% endblock %}
